
#include <stdio.h>
#include <gmp.h>

#include <pthread.h>

#include "rsa.h"

int used = 0;

int main(void)
{
    struct RsaPublic  pubkey;
    struct RsaPrivate privkey;

    mpz_t num; mpz_init(num);

    mpz_set_ui(num, 72);

    FILE *fp = fopen("/dev/urandom", "r");
    
    //mpz_init(privkey.mod); mpz_init(privkey.exp); mpz_init(privkey.d);
    //mpz_init(pubkey.mod);  mpz_init(pubkey.exp); mpz_init(privkey.u);

    rsa_genkeys(&pubkey, &privkey, 2048, fp);
    
    /*mpz_set_str(privkey.mod, "5E167DFD2D057F9DE46C4C545539CCD51A75381224325E3A0D2B4B6F6019C61D1AFAB9C7BB8F7F91420C50549A261D1707204F2F558B1DAF840FC8E26265B97636E0B01D5627DCEAEA5664A6B448FE1F6CDABCED10F8027F0A1C7D2F999341C73F40F18A0EC8AFD03ADD138C05C2506DF8D9385A9E149C33704D87E62E4CD1D77D183AA677BE277D55B8886AAFBB04428A5FF378924535E880B8FD7F47B953B472B1BEACA5DF8F116579C83151C483ED827CC4419E18B9D914B43303545725533AD9510B1081B883F52ADF9E58D25D2380AD2898A518CE0513A1BD6B7439E862C08522E0F72AA1040D89550A174AB92BF42B5C0208388F5EDD02DB6E611B189004A6D320858CF2F0A7AEB69CAB6952A44EDEBF33C6352B25EAB816CE8D11D4A1402A925DA95615143F24BD6F026D522083486567C93D1B99BB9812C6F60B8A0D4B8555A0B9D0A0F2DDB1F991BA4F02D75CBC1494EE45BE473C37DD52714E5FF736F38BB4DD6366A7E66FF2F5DAAF0C3AC3908D73F47D9448D925D17E45596BDA7B817E4CA5F543F52685A0C86CBA6ECF99CDEB684173ED7D0ECE29173C3E8B72C5D4E3C18E028A4A1C2DCBF5F7F121890573639DE413F38D90724A53C440DF62E3C0F9AA7A1C09CF6931218818E1DF321D114DF7FA20DE8F6AAF3E0997CA39B4E81FA6744BC3E3BCEDC7AA601747B77CAC1204470B5C82296DDA45F26DD6A11D", 16);    
    mpz_set(pubkey.mod, privkey.mod);

    mpz_set_str(privkey.exp, "10001", 16);
    mpz_set(pubkey.exp, privkey.exp);

    mpz_set_str(privkey.d, "22611F9A42382F207795E6F22DCE17FD8A5468AFA0505343ED09F3DF778313741126AA79C41C3425D4B78126D8C8B27A769D24B20C14F03CF1097F82D127907414AB574EF0EB51FAF8B3A6C58F3CD8B68CE50481AF60A030E175F57C4E2693B385766A8BE2C90C0D0F6536BE446073592BC3DBA6A8FAA8F4D6C54DB21B1AF0D6479C71D9E009388EC0A2D41DFFA65B7120F4DC9723036D264EDAC9AE177C2D8CD31805AF3A510D0AF344639539E68FBA5AA2D26793A83F48861B2E44BA2DB9B2C6DF1F90E6703006EFAFC1D42F6A76A40161C462BA78ECD6C80CA2953FFBE4E128ADBD47ECA8C3FB22231B52BB9E0F397357E09FD17731541D77ECCC51694038E88567E4D457EFC1934A418744367C40302BF4329A51EBCA63C784221B5A3F19A83A2F4A181F65C69E8C8B7B7D183140C7BD7B7EFF668D60A79D2F6C1C0B3BB8448D8156609E35F76FE541600FC448A0482C2AC5824AC5ACF5FF5BD16780BA18EA20B71D35B73D6E77DAAD3B085FAE5FBFAA41CABD3100CDB1A6C16141306B34415361767B909761F2D885A5E9882F51E2F7CA5B68F77F85A1676D8FEAC61373A0FCCB486EC768ECAE1BF3E8BCAF74E8205B3B86725F5531A1ADE57C0B4BA0888D47A25300B55963070DC24C1600C2B258FB746B34D9A911831A0C2CE516C67EAACE101088B9C605C0E39F65A803394477A5E51539669AE38663B054A4EB85A1", 16);
    
    //mpz_set_str(privkey.u, "5E167DFD2D057F9DE46C4C545539CCD51A75381224325E3A0D2B4B6F6019C61D1AFAB9C7BB8F7F91420C50549A261D1707204F2F558B1DAF840FC8E26265B97636E0B01D5627DCEAEA5664A6B448FE1F6CDABCED10F8027F0A1C7D2F999341C73F40F18A0EC8AFD03ADD138C05C2506DF8D9385A9E149C33704D87E62E4CD1D77D183AA677BE277D55B8886AAFBB04428A5FF378924535E880B8FD7F47B953B472B1BEACA5DF8F116579C83151C483ED827CC4419E18B9D914B43303545725533AD9510B1081B883F52ADF9E58D25D2380AD2898A518CE0513A1BD6B7439E862C08522E0F72AA1040D89550A174AB92BF42B5C0208388F5EDD02DB6E611B188EA8B225ACCF920FF1D5FC44642A4445E6746B29CB52E89F1E0BB72D4A68D525C48893C6F5AD7734C72F462E96ACC5D682C0AF2F1DFEED18E3A0BF7950FE97B145801960A646AB43B29F5059DAEABDA0D75A7A01EBB8A27DE83E22A26FA9D10053DB5F048AE59C4B1B53D034668EEA4BC9B717A6DA8FFEC80048663B3EE026724946DCA7DB7343698D0491DD06AC3331B32950805148181F5B1F83FB5500809B3DB2C1B074C284BFA7FCC1C5A8EC62AAB81F149951053F1F16417BCB8D8970FBD26FA13CB78531A2CE64222E391C53DCAB77F415AA626C86DC1261EFC2C7957A47B3EF9151BC4FFE1D0B665CC8ABE8B5798C29FFCC541105A29A1FBC86CBDD84E0", 16);
    */
    gmp_printf("%Zd\n\n", num);

    //gmp_printf("Mod = %ZX\nExp = %ZX\nKey = %ZX\nTotn = %ZX\n\n", privkey.mod, privkey.exp, privkey.d, privkey.u);

    printf("%d\n", rsa_encrypt(&num, pubkey, 2048, fp));
    gmp_printf("%ZX\n\n", num);

    printf("%d\n", rsa_decrypt(&num, privkey, 2048, fp));
    gmp_printf("%Zd\n\n", num);

    printf("used: %d\n", used);

    fclose(fp);
    
    mpz_clear(num);
    rsa_freekeypair(&pubkey, &privkey);
}

